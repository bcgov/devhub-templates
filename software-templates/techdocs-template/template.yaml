apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
    name: docs-template
    title: DevHub Technical Documentation Template
    description: Create a new repository for technical documentation
    tags:
        - techdocs
        - markdown
        - developer-experience
        - core
spec:
    owner: "developer-experience"
    type: documentation
    parameters:
        -   title: Provide information about your product (or service/component)
            properties:
                program_area:
                    title: Program area
                    type: string
                    description: Name of the program area associated with the product
                product_name:
                    title: Product acronym
                    type: string
                    description: An acronym used to identity the product, if there is one
                product_acronym:
                    title: Product acronym
                    type: string
                    description: An acronym used to identity the product, if there is one
                product_owner:
                    title: Product owner
                    type: string
                    description: Name of the individual in the Product Owner role for the product
                hosting_platform:
                    title: Hosting platform
                    type: string
                    description: Name of the technical platform where the product is hosted
        -   title: Provide information about your product's documentation
            required:
                - name
                - description
            properties:
                name:
                    title: Name
                    type: string
                    description: A unique name for the documentation
                    ui:field: EntityNamePicker
                    ui:autofocus: true
                description:
                    title: Description
                    type: string
                    description: A description for the documentation
                owner:
                    title: Owner
                    type: string
                    description: Team that owns the documentation
                    ui:field: OwnerPicker
                    ui:options:
                        allowArbitraryValues: false
                        catalogFilter:
                            - Group
        -   title: Specify repository details
            required:
                - repoUrl
            properties:
                repoUrl:
                    title: Repository Location
                    type: string
                    ui:field: RepoUrlPicker
                    ui:options:
                        requestUserCredentials: # this is super important - it causes the user to be prompted to log in to GitHub and/or authorize the required GH scopes.
                            secretsKey: USER_OAUTH_TOKEN
                            additionalScopes:
                                github:
                                    - workflow
                        allowedHosts:
                            - github.com
                        allowedOrganizations:
                            - bcgov
    steps:
        -   id: fetch-base
            name: Template Docs Skeleton
            action: fetch:template
            input:
                url: ./skeleton
                values:
                    name: ${{ parameters.name }}
                    description: ${{ parameters.description }}
                    destination: ${{ parameters.repoUrl | parseRepoUrl }}
                    owner: ${{ parameters.owner }}
        -   id: fetch-action
            name: Template Docs GitHub Action
            action: fetch:plain
            input:
                url: ../../shared/.github
                targetPath: ./.github
        -   id: publish
            name: Publish
            action: publish:github
            input:
                allowedHosts: [ "github.com" ]
                description: This is ${{ parameters.name }}
                repoUrl: ${{ parameters.repoUrl }}
                token: ${{ secrets.USER_OAUTH_TOKEN }} # this cause the GitHub publish to be performed as the logged in user and reduces the required permissions of the app itself.
                repoVisibility: "public"
                defaultBranch: "main"
                gitCommitMessage: "DevHub creating new repository for TechDocs. Created by ."
                gitAuthorName: ${{ user.entity.metadata.name }}
                gitAuthorEmail: ${{ user.entity.spec.profile.email }}
                hasProjects: false
                hasWiki: false
                topics: ["techdocs", "devhub"]
        -   id: register
            name: Register
            action: catalog:register
            input:
                repoContentsUrl: ${{ steps.publish.output.repoContentsUrl }}
                catalogInfoPath: "/catalog-info.yaml"
    output:
        links:
            -   title: Repository
                url: ${{ steps.publish.output.remoteUrl }}
            -   title: Open in catalog
                icon: catalog
                entityRef: ${{ steps.register.output.entityRef }}
